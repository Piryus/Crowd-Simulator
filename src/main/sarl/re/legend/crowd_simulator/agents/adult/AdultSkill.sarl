package re.legend.crowd_simulator.agents.adult

import com.badlogic.gdx.math.Vector2
import java.util.Random
import re.legend.crowd_simulator.behaviors.AdultState
import re.legend.crowd_simulator.entities.bodies.AdultBody
import re.legend.crowd_simulator.entities.bodies.AgentBody
import io.sarl.core.Logging

skill AdultSkill implements AdultCapacity {
	uses Logging

	// Body on which the actions will be applied
	var body : AdultBody

	def shop(position : Vector2) {
		throw new UnsupportedOperationException("TODO: auto-generated method stub")
	}

	def moveForward(body : AgentBody) {
		this.body = body as AdultBody
		this.body.setPosition(0, this.body.position.y + 1);
	}

	def moveBackward(body : AgentBody) {
		this.body = body as AdultBody
		this.body.setPosition(0, this.body.position.y - 1);
	}

	def turnLeft(body : AgentBody) {
		this.body = body as AdultBody
		this.body.setPosition(this.body.position.x - 1, 0);
	}

	def turnRight(body : AgentBody) {
		this.body = body as AdultBody
		this.body.setPosition(this.body.position.x + 1, 0);
	}

	def move(x : float, y : float) {
		this.body.setPosition(this.body.position.x + x, this.body.position.y + y);
	}

	def shop(status : AdultState) {
		if (status == AdultState::SHOP) {
			// Write moveForward skill first
		}
	}

	def moveRandomly(body : AgentBody) {
		// Retrieves the given body as an Adult Body
		this.body = body as AdultBody

		// Just a simple random number getter
		var rand = new Random
		// Delta movement on X axis
		var dirX : int
		// Delta movement on Y axis
		var dirY : int
		// Boolean used to check if the body isn't going through a wall
		var authorizedMove = true

		do {
			authorizedMove = true
			
			// Random direction on X axis
			if (rand.nextBoolean)
				dirX = 1
			else
				dirX = -1

			// Random direction on Y axis
			if (rand.nextBoolean)
				dirY = 1
			else
				dirY = -1

			// Checks for each body's perceived objects if the move doesn't put the body in a wall
			for (object : this.body.perceivedObjects) {
				if (
					// Move on X axis wrong
					(this.body.position.x >= object.position.x &&
					this.body.position.x <= object.position.x + 16 &&
					560 - this.body.position.y + dirY >= object.position.y &&
					560 - this.body.position.y + dirY <= object.position.y + 16) ||
					// Move on Y axis wrong
					(this.body.position.x + dirX >= object.position.x &&
					this.body.position.x + dirX <= object.position.x + 16 && 
					560 - this.body.position.y >= object.position.y &&
					560 - this.body.position.y <= object.position.y + 16)
					) {
					authorizedMove = false;
				}
			}
			

		} while (!authorizedMove);

		move(dirX, dirY)
	}

}
